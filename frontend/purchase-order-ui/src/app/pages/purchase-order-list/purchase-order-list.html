<section>
  <h2>Purchase Orders</h2>

  <button type="button" (click)="onAddNew()" [disabled]="showForm()">+ New Purchase Order</button>

  @if (showForm()) {
    <div class="form-container">
      @if (formError()) {
        <p style="color: red; margin-bottom: 1rem">{{ formError() }}</p>
      }
      <app-purchase-order-form
        [purchaseOrder]="editingPurchaseOrder()"
        (submit)="onFormSubmit($event)"
        (cancel)="onFormCancel()"
      />
    </div>
  }

  @if (deleteConfirm()) {
    <div class="modal-overlay">
      <div class="modal-content">
        <p>
          Are you sure you want to delete PO <strong>{{ deleteConfirm()?.poNumber }}</strong
          >?
        </p>
        <div class="modal-actions">
          <button
            type="button"
            class="modal-delete-btn"
            (click)="onDeleteConfirm()"
            [disabled]="deleteLoading()"
          >
            Delete
          </button>
          <button
            type="button"
            class="modal-cancel-btn"
            (click)="onDeleteCancel()"
            [disabled]="deleteLoading()"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  }

  <form (submit)="onApplyFilters($event)" aria-label="Filter and sort purchase orders">
    <label>
      Supplier
      <input
        type="text"
        [value]="supplier()"
        (input)="onSupplierChange($event)"
        placeholder="e.g. ACME"
      />
    </label>

    <label>
      Status
      <select [value]="status()" (change)="onStatusChange($event)">
        <option value="">All</option>
        @for (s of statusOptions; track s) {
          <option [value]="s">{{ s }}</option>
        }
      </select>
    </label>

    <label>
      Start Date
      <input type="date" [value]="startDate()" (change)="onStartDateChange($event)" />
    </label>

    <label>
      End Date
      <input type="date" [value]="endDate()" (change)="onEndDateChange($event)" />
    </label>

    <label>
      Sort by
      <select [value]="sortBy()" (change)="onSortByChange($event)">
        <option value="OrderDate">Order date</option>
        <option value="PoNumber">PO Number</option>
        <option value="SupplierName">Supplier</option>
        <option value="TotalAmount">Total amount</option>
      </select>
    </label>

    <label>
      Direction
      <select [value]="sortDir()" (change)="onSortDirChange($event)">
        <option value="asc">Ascending</option>
        <option value="desc">Descending</option>
      </select>
    </label>

    <label>
      Page size
      <select [value]="pageSize()" (change)="onPageSizeChange($event)">
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
    </label>

    <button type="submit">Apply</button>
  </form>
</section>

@if (loading()) {
  <p>Loading...</p>
} @else if (error()) {
  <p style="color: red">Error: {{ error() }}</p>
} @else {
  <table>
    <thead>
      <tr>
        <th>PO Number</th>
        <th>Description</th>
        <th>Supplier</th>
        <th>Order Date</th>
        <th>Total Amount</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      @for (po of purchaseOrders(); track po.id) {
        <tr>
          <td>{{ po.poNumber }}</td>
          <td>{{ po.description }}</td>
          <td>{{ po.supplierName }}</td>
          <td>{{ po.orderDate }}</td>
          <td>{{ po.totalAmount }}</td>
          <td>{{ po.status }}</td>
          <td>
            <button
              type="button"
              class="edit-btn"
              (click)="onEdit(po)"
              [disabled]="showForm() || deleteConfirm() !== null"
            >
              Edit
            </button>
            <button
              type="button"
              class="delete-btn"
              (click)="onDeleteClick(po)"
              [disabled]="showForm() || deleteConfirm() !== null"
            >
              Delete
            </button>
          </td>
        </tr>
      } @empty {
        <tr>
          <td colspan="7">No purchase orders found</td>
        </tr>
      }
    </tbody>
  </table>

  <div class="pagination">
    <button type="button" (click)="onPrevPage()" [disabled]="page() <= 1 || loading()">
      Previous
    </button>
    <span>Page {{ page() }} of {{ totalPages() }} â€” {{ totalRecords() }} total</span>
    <button type="button" (click)="onNextPage()" [disabled]="page() >= totalPages() || loading()">
      Next
    </button>
  </div>
}
